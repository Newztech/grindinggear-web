name: Docker Image CI for GHCR

on:
  push:
    branches: [ "main" ]  # Se ejecuta en cada push a main

env:
  REPO_NAME: ${{ github.event.repository.name }}  # ğŸ”¹ Obtiene el nombre del repositorio
  IMAGE_NAME: ghcr.io/${{ github.actor }}/${{ github.event.repository.name }}  # ğŸ”¹ Usa el nombre del repo como imagen

jobs:
  build_and_publish:
    runs-on: self-hosted  # ğŸ”¹ Se ejecuta en tu runner self-hosted

    steps:
    - name: ğŸ›ï¸ Checkout del cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” AutenticaciÃ³n en GitHub Container Registry (GHCR)
      env:
        GHCR_USERNAME: ${{ github.actor }}
        GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

    - name: ğŸ”¨ ConstrucciÃ³n de la imagen Docker
      run: |
        IMAGE_TAG=$(git rev-parse --short HEAD)
        echo "Construyendo imagen: $IMAGE_NAME:$IMAGE_TAG"
        docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .

    - name: ğŸ“¤ Subida de la imagen a GHCR
      run: |
        IMAGE_TAG=$(git rev-parse --short HEAD)
        echo "Subiendo imagen: $IMAGE_NAME:$IMAGE_TAG"
        docker push $IMAGE_NAME:$IMAGE_TAG
        docker push $IMAGE_NAME:latest

    - name: âœ… ConfirmaciÃ³n del proceso
      run: echo "âœ… Imagen subida correctamente a GHCR: $IMAGE_NAME"
